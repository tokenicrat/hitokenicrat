import os
import shutil
import sys

# Fancy colorful output
RED = "\033[0;31m"
GREEN = "\033[0;32m"
BLUE = "\033[0;34m"
YELLOW = "\033[1;33m"
RESET = "\033[0m"

# Logger with these colors
def log(content, level = 3):
    match level:
        case 1:
            print(f"{RED}ERROR{RESET}   {content}")
        case 2:
            print(f"{YELLOW}WARNING{RESET} {content}")
        case 3:
            print(f"{BLUE}INFO{RESET}    {content}")
        case 4:
            print(f"{GREEN}SUCCESS{RESET} {content}")

# Clean rubbish
def clean(site = False, tmp = True, ignore_error = False):
    log("Clean old site and temporary files")
    try:
        if site:
            shutil.rmtree("site", ignore_error)
        if tmp:
            shutil.rmtree("tmp", ignore_error)
    except Exception as e:
        log(e, 1)
        log("Error cleaning old files", 1)

# Handle unexpected exit
def unexpected_exit(code, clean_tmp = True):
    if clean_tmp:
        clean(False, True, True)
        log("Remove files created in this session and exit", 2)
        log("You may have to remove site yourself", 2)
    else:
        log("Exit", 2)
    exit(code)

# Read configuration defined in conf.py
try:
    import conf
except ImportError as e:
    log("Failed to read conf.py, does it exist?", 1)
    unexpected_exit(1)

# Read templates defined in template.py
try:
    import template
except ImportError as e:
    log("Failed to read template.py, does it exist?", 1)
    unexpected_exit(1)

# Validate required configuration
REQUIRED_VAR = ["SITE_NAME"]

for var in REQUIRED_VAR:
    if not var in conf.config:
        log("Some important variables are not set", 1)
        log("See docs for help")
        unexpected_exit(1)

# Clean everything before generating
clean(True, True, True)
log("Remove old content")
if os.path.isdir("site") or os.path.isdir("tmp"):
    log("Failed to delete old site, do you have the right permissions?", 2)
    log("Continue? [y/n]")
    a = "n"
    if not "-y" in sys.argv:
        a = input()
    if a in ["y", "Y", "yes", "Yes"] or "-y" in sys.argv:
        log("Continue w/o deleting old files", 2)
        pass
    else:
        log("Old site not deleted", 1)
        unexpected_exit(1)

# Create proper directory structure
try:
    os.mkdir("site")
except Exception as e:
    log(e, 1)
    log("Failed to create site structure", 1)
    unexpected_exit(1)

# Copy static files as is
try:
    shutil.copytree("static", "site/static")
except Exception as e:
    log(e, 1)
    log("Failed to copy static assets, do you have rw permissions?", 1)
    unexpected_exit(1)
log("Copy static files")

# Convert plain-text files into HTML format
def convert_text(type, in_txt, out_html):
    # TODO: Finish conversion part
    pass

if not os.path.isdir("source"):
    log("Missing source", 1)
    unexpected_exit(1)

try:
    for t in os.listdir("source"):
        t_path = os.path.join("source", t)
        if os.path.isdir(t_path):
            for f in os.listdir(t_path):
                f_path = os.path.join(t_path, f)
                convert_text(t, f_path, \
                    os.path.join("site", f, os.path.splitext(os.path.basename(f))[0]) + ".html"\
                    )
                # Resulting in site/[TEMPLATE]/[FILENAME_NOEXT].html
except Exception as e:
    log(e, 1)
    log(f"Errors occurred when converting text files", 1)
    unexpected_exit(1)

# Generate front page
# TODO: Finish this part

log("Successfully generated the site", 4)
